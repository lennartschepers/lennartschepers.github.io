<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chart.js Graph Builder</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    canvas { max-width: 100%; height: 400px; }
    .controls { margin-top: 1rem; }
    .controls input, .controls select, .controls button, .controls textarea {
      margin: 0.5rem 0;
      display: block;
      width: 100%;
    }
    iframe { width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>Chart.js Graph Builder</h1>

  <input type="file" id="csvInput" accept=".csv, .txt" />
  <div class="controls">
    <label>Chart Title: <input type="text" id="chartTitle" value="My Chart" /></label>
    <label>Chart Subtitle: <input type="text" id="chartSubtitle" value="Source: My Data" /></label>
    <label>Bar Spacing (categoryPercentage): <input type="number" id="barSpacing" step="0.1" min="0" max="1" value="0.8" /></label>
    <label>Axis Font Size: <input type="number" id="axisFontSize" value="12" /></label>
    <label>Colors (semicolon-separated for each category): <input type="text" id="colors" value="red;blue;green;orange" /></label>
    <button onclick="renderChart()">Render Chart</button>
    <button onclick="generateEmbed()">Export to Embed Code</button>
  </div>

  <canvas id="chartCanvas"></canvas>
  <textarea id="embedCode" readonly placeholder="Your iframe embed code will appear here..."></textarea>

  <script>
    let chart;
    let parsedData = null;

    document.getElementById('csvInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        const lines = evt.target.result.trim().split('\n');
        parsedData = lines.map(line => line.split(';'));
      };
      reader.readAsText(file);
    });

    function renderChart() {
      if (!parsedData || parsedData.length < 2) return alert('Please upload a valid file first.');

      const labels = parsedData[0].slice(1);
      const datasets = parsedData.slice(1).map((row, i) => {
        const colors = document.getElementById('colors').value.split(';');
        return {
          label: row[0],
          data: row.slice(1).map(Number),
          backgroundColor: colors[i % colors.length] || 'gray',
          categoryPercentage: parseFloat(document.getElementById('barSpacing').value)
        };
      });

      const axisFontSize = parseInt(document.getElementById('axisFontSize').value);
      const title = document.getElementById('chartTitle').value;
      const subtitle = document.getElementById('chartSubtitle').value;

      const config = {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: title, font: { size: 18 } },
            subtitle: { display: true, text: subtitle, font: { size: 14 } }
          },
          scales: {
            x: {
              ticks: { font: { size: axisFontSize } }
            },
            y: {
              ticks: { font: { size: axisFontSize } }
            }
          }
        }
      };

      if (chart) chart.destroy();
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      chart = new Chart(ctx, config);

      // Store config for embed
      window.lastConfig = config;
    }

    function generateEmbed() {
      if (!window.lastConfig) return alert('Render a chart first!');
      const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(window.lastConfig))));
      const iframeUrl = `${window.location.origin}/embed.html?chart=${encoded}`;
      const iframeCode = `<iframe src="${iframeUrl}" width="800" height="400" frameborder="0" allowfullscreen></iframe>`;
      document.getElementById('embedCode').value = iframeCode;
    }
  </script>
</body>
</html>

