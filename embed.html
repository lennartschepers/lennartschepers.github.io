<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Embedded Chart</title>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<style>
html, body {
	margin: 0;
	padding: 0;
	height: 100%;
	display: flex;
	align-items: center;
	justify-content: center;
}
	canvas {
		max-width: 100%;
		max-height: 100%;
	}
		</style>
	</head>
	<body>
		<canvas id="chartCanvas"></canvas>

		<script>
			function getChartConfigFromURL() {
				const params = new URLSearchParams(window.location.search);
				const encodedConfig = params.get("chart");
				if (!encodedConfig) return null;
				try {
					const decoded = decodeURIComponent(escape(atob(encodedConfig)));
					return JSON.parse(decoded);
				} catch (e) {
					console.error("Failed to parse chart config", e);
					return null;
				}
			}

			const config = getChartConfigFromURL();

			if (config) {
				const ctx = document.getElementById("chartCanvas").getContext("2d");

				let selectedCategory = null;
				// Save original colors from datasets for restoring later
				const originalColors = config.data.datasets.map(ds => ds.backgroundColor);

				// Wrap the onHover handler (or add if missing)
				config.options = config.options || {};
				config.options.onHover = (evt, elements) => {
					if (elements.length) {
						const ix = elements[0].datasetIndex;
						const category = config.data.datasets[ix].label;
						if (selectedCategory !== category) {
							selectedCategory = category;
							applyHighlight();
						}
					} else {
						selectedCategory = null;
						applyHighlight();
					}
				};

				// add mouseleave handler to canvas to reset highlight
				const chart = new Chart(ctx, config);

				document.getElementById("chartCanvas").addEventListener("mouseleave", () => {
					selectedCategory = null;
					applyHighlight();
				});

				function applyHighlight() {
					chart.data.datasets.forEach((ds, i) => {
						if (selectedCategory && ds.label !== selectedCategory) {
							ds.backgroundColor = "rgba(200,200,200,0.3)";
						} else {
							ds.backgroundColor = originalColors[i];
						}
					});
					chart.update();
				}
			} else {
				document.body.innerHTML = "<p style='font-family:sans-serif;'>Invalid or missing chart data.</p>";
			}
		</script>


	</body>
</html>

